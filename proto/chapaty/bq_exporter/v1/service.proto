syntax = "proto3";
package chapaty.bq_exporter.v1;

option go_package = "github.com/LenWilliamson/chapaty-bq-exporter/gen/go/chapaty/bq_exporter/v1;bqexporterv1";

import "proto/chapaty/data/v1/common.proto";
import "proto/chapaty/data/v1/tick_spot.proto";
import "proto/chapaty/data/v1/ohlcv_spot.proto";
import "proto/chapaty/data/v1/ohlcv_future.proto";
import "proto/chapaty/data/v1/tpo_spot.proto";
import "proto/chapaty/data/v1/tpo_future.proto";
import "proto/chapaty/data/v1/volume_profile_spot.proto";
import "proto/chapaty/data/v1/economic_calendar.proto";

service ExporterService {
    // Streams market data based on a flexible query.
    rpc StreamData(StreamDataRequest) returns (stream StreamDataResponse);
}

message StreamDataRequest {
    // Required: Specify the source of the data.
    chapaty.data.v1.DataBroker data_broker = 1;
    
    // Required: Specify the kind of schema to retrieve.
    // This determines which other fields are required.
    chapaty.data.v1.SchemaKind schema_kind = 2;
    
    // Required: Symbol/contract identifier (e.g., "btc-usdt", "6ez5")
    // The schema_kind already indicates if this is spot or futures data.
    string symbol = 3;
    
    // Required: The year for which data is requested (e.g., 2025).
    int32 year = 4;
    
    // Optional: Exchange name (e.g., "binance", "cme")
    // If empty, defaults to the name of the given data_broker.
    string exchange = 5;
    
    // Optional: Base timeframe period for OHLCV/TPO data (e.g., "1m", "5m", "1h", "1d")
    // Required for: OHLCV_SPOT, OHLCV_FUTURE, TPO_SPOT, TPO_FUTURE
    // Default: "1m"
    // Not used for: TICK_SPOT, VOLUME_PROFILE_SPOT
    string period = 6;
    
    // Optional: Aggregation timeframe for volume profile and TPO queries.
    // Format: N{m|h|d|w} (e.g., "5m", "1h", "1d", "1w")
    // Aggregates base 1-minute data to the specified resolution.
    // Defaults to "1m" (no aggregation) if not specified.
    // Only used for: VOLUME_PROFILE_SPOT, TPO_SPOT, TPO_FUTURE
    string agg_time_frame = 7;
    
    // Optional: Price bin size for volume profile and TPO aggregation (in quote currency).
    // Examples: 1.0 (1 USD bins), 5.0 (5 USD bins), 0.01 (1 cent bins), 0.00005 (6e tick size)
    // Rebuckets base granular price bins to the specified size.
    // Defaults to the finest available price granularity if not specified.
    // Only used for: VOLUME_PROFILE_SPOT, TPO_SPOT, TPO_FUTURE
    double agg_price_bin = 8;
    
    // Optional: Data source identifier for economic calendar events (e.g., "investing.com", "fred")
    // Filters economic calendar data by the provider/source of the event.
    // If empty, returns events from all available data sources.
    // Only used for: ECONOMIC_CALENDAR
    string data_source = 9;
    
    // Optional: Maximum events per batch in streaming responses.
    // Allows clients to tune latency vs throughput.
    // Defaults to 1000 if not specified or set to 0.
    // Recommended range: 100-10000 depending on event size and network conditions.
    int32 batch_size = 100;
}

message StreamDataResponse {
    DataBatch batch = 1;
}

message DataBatch {
    // Each batch contains only events - no repeated metadata.
    // The client combines this with the metadata from the first message.
    oneof data {
        // Tick-level data for spot markets
        chapaty.data.v1.TickSpotBatch tick_spot = 1;

        // OHLCV (Open-High-Low-Close-Volume) data for spot markets
        chapaty.data.v1.OhlcvSpotBatch ohlcv_spot = 2;

        // OHLCV data for futures markets
        chapaty.data.v1.OhlcvFutureBatch ohlcv_future = 3;

        // TPO (Time Price Opportunity) data for spot markets
        chapaty.data.v1.TpoSpotBatch tpo_spot = 4;

        // TPO data for futures markets
        chapaty.data.v1.TpoFutureBatch tpo_future = 5;

        // Volume Profile data for spot markets
        chapaty.data.v1.VolumeProfileSpotBatch volume_profile_spot = 6;

        // Economic calendar data (e.g., macroeconomic releases)
        chapaty.data.v1.EconomicCalendarBatch economic_calendar = 7;
    }
    
    // Sequence number for this batch (starts at 0)
    int64 sequence = 100;
    
    // True if this is the final batch in the stream
    bool is_final = 110;
}