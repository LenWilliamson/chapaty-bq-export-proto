syntax = "proto3";
package chapaty.bq_exporter.v1;

option go_package = "github.com/LenWilliamson/chapaty-bq-exporter/gen/go/chapaty/bq_exporter/v1;bqexporterv1";

import "chapaty/data/v1/common.proto";
import "chapaty/data/v1/tick_spot.proto";
import "chapaty/data/v1/ohlcv_spot.proto";
import "chapaty/data/v1/ohlcv_future.proto";
import "chapaty/data/v1/tpo_spot.proto";
import "chapaty/data/v1/tpo_future.proto";
import "chapaty/data/v1/volume_profile_spot.proto";
import "chapaty/data/v1/economic_calendar.proto";

// Market data export service.
service ExporterService {
  // Stream tick-level spot market data
  rpc TickSpot(TickSpotRequest) returns (stream TickSpotResponse);

  // Stream OHLCV data for spot markets
  rpc OhlcvSpot(OhlcvSpotRequest) returns (stream OhlcvSpotResponse);

  // Stream OHLCV data for futures markets
  rpc OhlcvFuture(OhlcvFutureRequest) returns (stream OhlcvFutureResponse);

  // Stream TPO data for spot markets
  rpc TpoSpot(TpoSpotRequest) returns (stream TpoSpotResponse);

  // Stream TPO data for futures markets
  rpc TpoFuture(TpoFutureRequest) returns (stream TpoFutureResponse);

  // Stream volume profile data for spot markets
  rpc VolumeProfileSpot(VolumeProfileSpotRequest) returns (stream VolumeProfileSpotResponse);

  // Stream economic calendar events
  rpc EconomicCalendar(EconomicCalendarRequest) returns (stream EconomicCalendarResponse);
}

// ============================================================================
// Common Types
// ============================================================================

// Base parameters common to all market data queries
message BaseMarketParams {
  // Required: Data source
  chapaty.data.v1.DataBroker data_broker = 1;

  // Required: Symbol identifier (e.g., "btc-usdt", "6ez5")
  string                     symbol      = 2;

  // Required: Year for data retrieval
  int32                      year        = 3;

  // Optional: Exchange name. Defaults to data_broker name if empty.
  string                     exchange    = 4;

  // Optional: Batch size for streaming. Defaults to 1000. Range: 100-10000.
  int32                      batch_size  = 5;
}

// Aggregation parameters for profile-based data
message ProfileAggregation {
  // Aggregation timeframe (e.g., "5m", "1h", "1d", "1w")
  // Defaults to "1m" if not specified.
  string time_frame = 1;

  // Price bin size in quote currency (e.g., 1.0, 0.01, 0.00005)
  // Defaults to finest available granularity if not specified.
  double price_bin  = 2;
}

// Standard batch metadata
message BatchMetadata {
  // Sequence number for this batch (starts at 0)
  int64 sequence = 1;

  // True if this is the final batch
  bool  is_final = 2;
}

// ============================================================================
// Tick Spot
// ============================================================================

message TickSpotRequest {
  BaseMarketParams params = 1;
}

message TickSpotResponse {
  chapaty.data.v1.TickSpotBatch batch    = 1;
  BatchMetadata                 metadata = 2;
}

// ============================================================================
// OHLCV Spot
// ============================================================================

message OhlcvSpotRequest {
  BaseMarketParams params = 1;

  // Timeframe period (e.g., "1m", "5m", "1h", "1d")
  // Defaults to "1m" if not specified.
  string           period = 2;
}

message OhlcvSpotResponse {
  chapaty.data.v1.OhlcvSpotBatch batch    = 1;
  BatchMetadata                  metadata = 2;
}

// ============================================================================
// OHLCV Future
// ============================================================================

message OhlcvFutureRequest {
  BaseMarketParams params = 1;

  // Timeframe period (e.g., "1m", "5m", "1h", "1d")
  // Defaults to "1m" if not specified.
  string           period = 2;
}

message OhlcvFutureResponse {
  chapaty.data.v1.OhlcvFutureBatch batch    = 1;
  BatchMetadata                    metadata = 2;
}

// ============================================================================
// TPO Spot
// ============================================================================

message TpoSpotRequest {
  BaseMarketParams   params      = 1;

  // Optional: Aggregation parameters
  ProfileAggregation aggregation = 2;
}

message TpoSpotResponse {
  chapaty.data.v1.TpoSpotBatch batch    = 1;
  BatchMetadata                metadata = 2;
}

// ============================================================================
// TPO Future
// ============================================================================

message TpoFutureRequest {
  BaseMarketParams   params      = 1;

  // Optional: Aggregation parameters
  ProfileAggregation aggregation = 2;
}

message TpoFutureResponse {
  chapaty.data.v1.TpoFutureBatch batch    = 1;
  BatchMetadata                  metadata = 2;
}

// ============================================================================
// Volume Profile Spot
// ============================================================================

message VolumeProfileSpotRequest {
  BaseMarketParams   params      = 1;

  // Optional: Aggregation parameters
  ProfileAggregation aggregation = 2;
}

message VolumeProfileSpotResponse {
  chapaty.data.v1.VolumeProfileSpotBatch batch    = 1;
  BatchMetadata                          metadata = 2;
}

// ============================================================================
// Economic Calendar
// ============================================================================

message EconomicCalendarRequest {
  // Required: Data source
  chapaty.data.v1.DataBroker data_broker   = 1;

  // Required: Year for data retrieval
  int32                      year          = 2;

  // Optional: Filter by data source (e.g., "investingcom", "fred")
  string                     data_source   = 3;

  // Optional: Filter by ISO 4217 lowercase currency code (e.g., "usd", "eur")
  string                     currency_code = 4;

  // Optional: Batch size. Defaults to 1000.
  int32                      batch_size    = 5;
}

message EconomicCalendarResponse {
  chapaty.data.v1.EconomicCalendarBatch batch    = 1;
  BatchMetadata                         metadata = 2;
}