syntax = "proto3";
package chapaty.bq_exporter.v1;

option go_package = "github.com/LenWilliamson/chapaty-bq-exporter/gen/go/chapaty/bq_exporter/v1;bqexporterv1";

import "proto/chapaty/data/v1/common.proto";
import "proto/chapaty/data/v1/tick_spot.proto";
import "proto/chapaty/data/v1/ohlcv_spot.proto";
import "proto/chapaty/data/v1/ohlcv_future.proto";
import "proto/chapaty/data/v1/tpo_spot.proto";
import "proto/chapaty/data/v1/tpo_future.proto";
import "proto/chapaty/data/v1/volume_profile_spot.proto";
import "proto/chapaty/data/v1/economic_calendar.proto";

// Market data export service.
// Each RPC is specialized for a specific data type, providing clear contracts
// and enabling independent evolution of each endpoint.
service ExporterService {
  // Stream tick-level spot market data
  rpc StreamTickSpot(StreamTickSpotRequest) returns (stream StreamTickSpotResponse);

  // Stream OHLCV data for spot markets
  rpc StreamOhlcvSpot(StreamOhlcvSpotRequest) returns (stream StreamOhlcvSpotResponse);

  // Stream OHLCV data for futures markets
  rpc StreamOhlcvFuture(StreamOhlcvFutureRequest) returns (stream StreamOhlcvFutureResponse);

  // Stream TPO data for spot markets
  rpc StreamTpoSpot(StreamTpoSpotRequest) returns (stream StreamTpoSpotResponse);

  // Stream TPO data for futures markets
  rpc StreamTpoFuture(StreamTpoFutureRequest) returns (stream StreamTpoFutureResponse);

  // Stream volume profile data for spot markets
  rpc StreamVolumeProfileSpot(StreamVolumeProfileSpotRequest) returns (stream StreamVolumeProfileSpotResponse);

  // Stream economic calendar events
  rpc StreamEconomicCalendar(StreamEconomicCalendarRequest) returns (stream StreamEconomicCalendarResponse);
}

// ============================================================================
// Common Types
// ============================================================================

// Base parameters common to all market data queries
message BaseMarketParams {
  // Required: Data source
  chapaty.data.v1.DataBroker data_broker = 1;

  // Required: Symbol identifier (e.g., "btc-usdt", "6ez5")
  string                     symbol      = 2;

  // Required: Year for data retrieval
  int32                      year        = 3;

  // Optional: Exchange name. Defaults to data_broker name if empty.
  string                     exchange    = 4;

  // Optional: Batch size for streaming. Defaults to 1000. Range: 100-10000.
  int32                      batch_size  = 5;
}

// Aggregation parameters for profile-based data
message ProfileAggregation {
  // Aggregation timeframe (e.g., "5m", "1h", "1d", "1w")
  // Defaults to "1m" if not specified.
  string time_frame = 1;

  // Price bin size in quote currency (e.g., 1.0, 0.01)
  // Defaults to finest available granularity if not specified.
  double price_bin  = 2;
}

// Standard batch metadata
message BatchMetadata {
  // Sequence number for this batch (starts at 0)
  int64 sequence = 1;

  // True if this is the final batch
  bool  is_final = 2;
}

// ============================================================================
// Tick Spot
// ============================================================================

message StreamTickSpotRequest {
  BaseMarketParams params = 1;
}

message StreamTickSpotResponse {
  chapaty.data.v1.TickSpotBatch batch    = 1;
  BatchMetadata                 metadata = 2;
}

// ============================================================================
// OHLCV Spot
// ============================================================================

message StreamOhlcvSpotRequest {
  BaseMarketParams params = 1;

  // Timeframe period (e.g., "1m", "5m", "1h", "1d")
  // Defaults to "1m" if not specified.
  string           period = 2;
}

message StreamOhlcvSpotResponse {
  chapaty.data.v1.OhlcvSpotBatch batch    = 1;
  BatchMetadata                  metadata = 2;
}

// ============================================================================
// OHLCV Future
// ============================================================================

message StreamOhlcvFutureRequest {
  BaseMarketParams params = 1;

  // Timeframe period (e.g., "1m", "5m", "1h", "1d")
  // Defaults to "1m" if not specified.
  string           period = 2;
}

message StreamOhlcvFutureResponse {
  chapaty.data.v1.OhlcvFutureBatch batch    = 1;
  BatchMetadata                    metadata = 2;
}

// ============================================================================
// TPO Spot
// ============================================================================

message StreamTpoSpotRequest {
  BaseMarketParams   params      = 1;

  // Optional: Aggregation parameters
  ProfileAggregation aggregation = 3;
}

message StreamTpoSpotResponse {
  chapaty.data.v1.TpoSpotBatch batch    = 1;
  BatchMetadata                metadata = 2;
}

// ============================================================================
// TPO Future
// ============================================================================

message StreamTpoFutureRequest {
  BaseMarketParams   params      = 1;

  // Optional: Aggregation parameters
  ProfileAggregation aggregation = 3;
}

message StreamTpoFutureResponse {
  chapaty.data.v1.TpoFutureBatch batch    = 1;
  BatchMetadata                  metadata = 2;
}

// ============================================================================
// Volume Profile Spot
// ============================================================================

message StreamVolumeProfileSpotRequest {
  BaseMarketParams   params      = 1;

  // Optional: Aggregation parameters
  ProfileAggregation aggregation = 2;
}

message StreamVolumeProfileSpotResponse {
  chapaty.data.v1.VolumeProfileSpotBatch batch    = 1;
  BatchMetadata                          metadata = 2;
}

// ============================================================================
// Economic Calendar
// ============================================================================

message StreamEconomicCalendarRequest {
  // Required: Data source
  chapaty.data.v1.DataBroker data_broker   = 1;

  // Required: Year for data retrieval
  int32                      year          = 2;

  // Optional: Filter by data source (e.g., "investingcom", "fred")
  string                     data_source   = 3;

  // Optional: Filter by ISO 4217 currency code (e.g., "USD", "EUR")
  string                     currency_code = 4;

  // Optional: Batch size. Defaults to 1000.
  int32                      batch_size    = 5;
}

message StreamEconomicCalendarResponse {
  chapaty.data.v1.EconomicCalendarBatch batch    = 1;
  BatchMetadata                         metadata = 2;
}